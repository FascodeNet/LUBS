#!/usr/bin/env bash

set -e -u

export LANG=C


arch=amd64
cache_dir="cache"
work_dir="work"
script_path=$(readlink -f ${0%/*})
codename="focal"
#codename="bionic"
mirror="http://ftp.jaist.ac.jp/pub/Linux/ubuntu/"


# Show an INFO message
# _msg_info <message>
_msg_info () {
    local _msg="${@}"
    echo -e "\033[0;36m[LUBS Core] \033[0;32mINFO:\033[0;39m ${_msg}"
}

# Show an ERROR message then exit with status
# _msg_error <message> <exit code>
_msg_error() {
    local _msg="${1}"
    local _error=${2}
    echo -e "\033[0;36m[LUBS Core] \033[0;31mERROR:\033[0;39m ${_msg}" >&2
    if [[ ! ${_error} = 0 ]]; then
        exit ${_error}
    fi
}


# Helper function to run make_*() only one time.
run_once() {
    if [[ ! -e "${work_dir}/build.${1}" ]]; then
        "$1"
        touch "${work_dir}/build.${1}"
    fi
}


run_cmd () {
    "${script_path}/lubs-chroot" "${work_dir}/airootfs" ${@}
}

_apt_install () {
    run_cmd apt-get --yes install ${@}
}




prepare_build () {
    if [[ ${EUID} -ne 0 ]]; then
        _msg_error "This script must be run as root." 1
    fi
    
    [[ ! -d "${work_dir}" ]] && mkdir -p "${work_dir}"

    local mount
    for mount in $(mount | awk '{print $3}' | grep $(realpath ${work_dir}) | sort -r); do
        _msg_info "Unmounting ${mount}"
        umount "${mount}"
    done

}


make_basefs () {
    if [[ ! -d "${cache_dir}/${codename}" ]]; then
        _msg_info "Installing Ubuntu to '${cache_dir}/${codename}'..."
        mkdir -p "${cache_dir}/${codename}"
        debootstrap --arch=${arch} --include=linux-image-generic  --verbose --merged-usr "${codename}" "${cache_dir}/${codename}" ${mirror}
        rm "${cache_dir}/${codename}/var/cache/apt/archives/*.deb"
        _msg_info "${codename} installed successfully!"
    fi
    
    rm -rf "${work_dir}/airootfs" && mkdir -p "${work_dir}/airootfs"
    _msg_info "copy base files from '${cache_dir}/${codename}' to '${work_dir}/airootfs'..."
    rsync  -au "${cache_dir}/${codename}/" "${work_dir}/airootfs"
    echo 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:${PATH}' >> "${work_dir}/airootfs/etc/bash.bashrc"
    run_cmd apt-get update
    # run_cmd apt-get upgrade
    _msg_info "make basefs done!"
}

make_sourcelist () {
    cp ${script_path}/source.list.d/${codename}/* ${work_dir}/airootfs/etc/apt
}

make_packages () {
    run_cmd apt-get update
    installpkglist=($(grep -h -v ^'#' ${script_path}/packages.x86_64))
    run_cmd sudo -i apt-get --yes install ${installpkglist[@]}
}

make_customize_airootfs() {
    # Overwrite airootfs with customize_airootfs.
    cp -af "${script_path}/airootfs" "${work_dir}"

    if [[ -f "${work_dir}/airootfs/root/customize_airootfs.sh" ]]; then
    	chmod 755 "${work_dir}/airootfs/root/customize_airootfs.sh"
        run_cmd "/root/customize_airootfs.sh"
    fi
}

prepare_build
run_once make_basefs
run_once make_sourcelist
run_once make_packages
run_once make_customize_airootfs
